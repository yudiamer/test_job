pipeline {
  agent any

  environment {
    DOCKER_IMAGE = 'trade-trends-automation'
    DOCKER_TAG = "${BUILD_NUMBER}"
    XFLUSH_USERNAME = credentials('xflush-username')        // Secret Text (if username/password use different binding)
    XFLUSH_PASSWORD = credentials('xflush-password')
    DINGTALK_WEBHOOK = credentials('dingtalk-webhook-url')
    DINGTALK_SECRET = credentials('dingtalk-webhook-secret')
  }

  parameters {
    choice(name: 'TIME_RANGE', choices: ['default', 'today', 'custom'], description: 'Report time range')
    string(name: 'CUSTOM_TIME_RANGE', defaultValue: '', description: 'YYYY-MM-DD HH:MM:SS,YYYY-MM-DD HH:MM:SS')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Image') {
      steps {
        script {
          def img = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}", "TradeTrendAutomation")
          sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
        }
      }
    }

    stage('Run Automation') {
      steps {
        script {
          def timeRangeArg = ""
          if (params.TIME_RANGE == 'today') {
            timeRangeArg = "--time-range today"
          } else if (params.TIME_RANGE == 'custom' && params.CUSTOM_TIME_RANGE?.trim()) {
            timeRangeArg = "--time-range \"${params.CUSTOM_TIME_RANGE}\""
          }

          docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").inside(
            '--shm-size=2g --cap-add=SYS_ADMIN'
          ) {
            sh """
              if command -v python3 >/dev/null 2>&1; then PY=python3; else PY=python; fi
              \$PY run_automation.py ${timeRangeArg} --headless
            """
          }
        }
      }
    }
  }

  post {
    success {
      archiveArtifacts artifacts: 'tps_data.json', allowEmptyArchive: true
    }
    failure {
      echo 'Failure encountered'
    }
    always {
      sh "docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true"
    }
  }
}
